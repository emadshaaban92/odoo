/** @odoo-module alias=website.configurator_tour **/
import { patch } from 'web.utils';
import { WebsitePreview } from '@website/client_actions/website_preview/website_preview';
import wTourUtils from 'website.tour_utils';

patch(WebsitePreview.prototype, 'website_preview_configurator_tour', {
    /**
     * @override
     */
    _onPageLoaded() {
        const _super = this._super(...arguments);
        if (this._configuratorTourRegistered) {
            return _super;
        }
        const isHomepage = this.iframe.el.contentDocument.getElementById('wrapwrap').classList.contains('homepage');
        if (isHomepage) {
            this.iframe.el.contentWindow.addEventListener('PUBLIC-ROOT-READY', () => {
                this._registerConfiguratorTour();
            });
        }
        return _super;
    },
    /**
     * Creates an adapted tour for the homepage generated by the configurator.
     */
    _registerConfiguratorTour() {
        let titleSelector = '#wrap > section:first-child';
        const $ = this.iframe.el.contentWindow.$;
        let title = $(titleSelector).find('h1, h2').first();
        if (!title.length) {
            titleSelector = titleSelector.replace('section:first-child', 'section:nth-child(2)');
            title = $(titleSelector).find('h1, h2').first();
        }
        let isTitleTextImage = $(titleSelector).hasClass('s_text_image');
        titleSelector = titleSelector.concat(` ${title.is('h1') ? 'h1' : 'h2'}`);

        const shapeSelector = '#wrap > section[data-oe-shape-data]';
        const backgroundSelector = '#wrap > section:nth-child(2)';

        const imageStep = isTitleTextImage ?
            wTourUtils.changeImage(titleSelector.replace('h2', 'img')) : wTourUtils.changeBackground();

        const backgroundColorStep = [wTourUtils.changeBackgroundColor()];
        if (!isTitleTextImage) {
            backgroundColorStep.unshift(wTourUtils.clickOnSnippet(backgroundSelector));
        }

        const shapeStep = [];
        if ($(shapeSelector).first().length) {
            if (!$(backgroundSelector).is($(shapeSelector))) {
                shapeStep.push(wTourUtils.clickOnSnippet(shapeSelector));
            }
            shapeStep.push(wTourUtils.changeOption('BackgroundShape', 'we-toggler', this.env._t('Background Shape')));
            shapeStep.push(wTourUtils.selectNested('we-select-page', 'BackgroundShape', ':not(.o_we_pager_controls)', this.env._t('Background Shape')));
        }

        const steps = [
            wTourUtils.clickOnText(titleSelector),
            imageStep,
            ...backgroundColorStep,
            ...shapeStep,
            wTourUtils.changePaddingSize('top'),
        ];

        wTourUtils.registerThemeHomepageTour('configurator_tour', steps);
        this._configuratorTourRegistered = true;
    }
});
