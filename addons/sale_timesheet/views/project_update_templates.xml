<?xml version="1.0"?>
<odoo>
    <template id="project_update_default_description" inherit_id="project.project_update_default_description">
        <!--As this template is rendered in an html field, the spaces may be interpreted as nbsp while editing. -->
        <xpath expr="//div[@name='milestone']" position="before">
<br/>
<div t-if="show_sold">
<h3 style="font-weight: bolder"><u>Sold</u></h3>
<table class="table table-striped">
<thead class="border-2 border-start-0 border-end-0">
<td class="fw-bolder">Service</td>
<td class="fw-bolder text-end">Sold</td>
<td class="fw-bolder text-end">Effective</td>
<td class="fw-bolder text-end">Remaining</td>
</thead>
<tbody>
<tr t-foreach="services['data']" t-as="service">
<t t-set="is_unit" t-value="service['is_unit']"/>
<td t-attf-class="#{ 'fst-italic' if is_unit else ''}"><t t-out="service['name']"/></td>
<td t-attf-class="#{ 'fst-italic' if is_unit else ''}" style="text-align: right; vertical-align: middle;"><t t-out="format_value(service['sold_value'], service['is_hour'])"/> <t t-out="service['unit']"/></td>
<td t-attf-class="#{ 'fst-italic' if is_unit else ''}" style="text-align: right; vertical-align: middle;"><t t-out="format_value(service['effective_value'], service['is_hour'])"/> <t t-out="service['unit']"/></td>
<td t-attf-class="#{ 'fst-italic' if is_unit else ''}" style="text-align: right; vertical-align: middle;"><t t-out="format_value(service['remaining_value'], service['is_hour'])"/> <t t-out="service['unit']"/></td>
</tr>
<tfoot>
<td style="font-weight: bolder; text-align: right">Total</td>
<td style="font-weight: bolder; text-align: right; vertical-align: middle;"><t t-out="format_value(services['total_sold'], services['is_hour'])"/> <t t-out="services['company_unit_name']"/></td>
<td style="font-weight: bolder; text-align: right; vertical-align: middle;"><t t-out="format_value(services['total_effective'], services['is_hour'])"/> <t t-out="services['company_unit_name']"/></td>
<td style="font-weight: bolder; text-align: right; vertical-align: middle;"><t t-out="format_value(services['total_remaining'], services['is_hour'])"/> <t t-out="services['company_unit_name']"/></td>
</tfoot>
</tbody>
</table>
<br/>
</div>        
        
<div name="profitability" t-if="show_profitability">
<t t-if="project.analytic_account_id and project.allow_billable and user.has_group('project.group_project_manager')" name="costs">
<h3 style="font-weight: bolder"><u>Profitability</u></h3>
<t t-if="project.analytic_account_id.line_ids"> The cost of the project is now at <t t-out="profitability['costs_formatted']"/>, for a revenue of <t t-out="profitability['revenues_formatted']"/>, leading to a
<span>
<font t-if="profitability['margin'] &gt; 0"  style="color: rgb(0, 128, 0)">
<b><t t-out="profitability['margin_formatted']"/></b>
</font>
<font t-elif="profitability['margin'] &lt; 0" style="color: rgb(128, 0, 0)">
<b><t t-out="profitability['margin_formatted']"/></b>
</font>
<t t-else="" t-out="profitability['margin_formatted']"/>
</span> margin (<t t-out="profitability['margin_percentage']"/>%).
</t>

<div t-if="profitability['profitability_items']" name="profitability_detail" class="mt-4">
    <table class="table table-striped">
        <thead class="border-2 border-start-0 border-end-0">
            <tr>
                <td class="fw-bolder">Revenues</td>
                <td class="fw-bolder text-end">Invoiced</td>
                <td class="fw-bolder text-end">To Invoice</td>
                <td class="fw-bolder text-end">Expected</td>
            </tr>
        </thead>
        <tbody>
            <t t-set="revenues" t-value="profitability['profitability_items']['revenues']"/>
            <tr t-foreach="revenues['data']" t-as="revenue">
                <td t-out="profitability_labels[revenue['id']]"/>
                <td class="text-end" t-out="revenue['invoiced_formatted']"/>
                <td class="text-end" t-out="revenue['to_invoice_formatted']"/>
                <td class="text-end" t-out="revenue['expected_revenue_formatted']"/>
            </tr>
            <tfoot>
                <td class="fw-bolder text-end">Total</td>
                <td class="fw-bolder text-end" t-out="profitability['total_invoiced_formatted']"/>
                <td class="fw-bolder text-end" t-out="profitability['total_to_invoice_formatted']"/>
                <td class="fw-bolder text-end" t-out="profitability['revenues_formatted']"/>
            </tfoot>
        </tbody>
    </table>
    <table class="table table-striped mt-4">
        <thead class="border-2 border-start-0 border-end-0">
            <tr>
                <td class="fw-bolder">Costs</td>
                <td class="fw-bolder text-end">Billed</td>
                <td class="fw-bolder text-end">To Bill</td>
                <td class="fw-bolder text-end">Expected</td>
            </tr>
        </thead>
        <tbody>
            <t t-set="costs" t-value="profitability['profitability_items']['costs']"/>
            <tr t-foreach="costs['data']" t-as="cost">
                <td t-out="profitability_labels[cost['id']]"/>
                <td class="text-end" t-out="cost['billed_formatted']"/>
                <td class="text-end" t-out="cost['to_bill_formatted']"/>
                <td class="text-end" t-out="cost['expected_cost_formatted']"/>
            </tr>
            <tfoot>
                <td class="fw-bolder text-end">Total</td>
                <td class="fw-bolder text-end" t-out="profitability['total_cost_billed_formatted']"/>
                <td class="fw-bolder text-end" t-out="profitability['total_cost_to_billed_formatted']"/>
                <td class="fw-bolder text-end" t-out="profitability['costs_formatted']"/>
            </tfoot>
        </tbody>
    </table>
    <br/>
    <table class="table table-sm">
        <tr>
            <td class="fw-bolder">Margin</td>
            <td class="fw-bolder text-end" t-out="profitability['costs_formatted']"/>
            <td class="fw-bolder text-end" t-out="profitability['revenues_formatted']"/>
            <td class="fw-bolder text-end" t-out="profitability['margin_formatted']"/>
        </tr>
    </table>
</div>
</t>
</div>
        </xpath>
    </template>

</odoo>
