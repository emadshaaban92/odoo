<?xml version="1.0" encoding="UTF-8" ?>
<templates xml:space="preserve">

<t t-name="mail.message" owl="1">
    <div class="o-mail-message position-relative py-1 mt-1" t-att-class="{
            'o-mail-is-author': props.message.isAuthor,
            'px-3': !env.inChatWindow,
            'px-1': env.inChatWindow,
            'o-highlighted bg-view shadow-lg': props.highlighted,
            'opacity-50': props.grayedOut,
        }"
        t-att-data-message-id="props.message.id"
        t-ref="ref"
    >
        <MessageInReplyTo t-if="props.message.parentMessage" alignedRight="isAlignedRight" message="props.message" onClick="props.onParentMessageClick"/>
        <div class="o-mail-message-core position-relative d-flex flex-shrink-0">
            <div class="o-mail-message-sidebar d-flex flex-shrink-0 justify-content-center">
                <div t-if="!props.squashed" class="o-mail-avatar-container position-relative bg-view">
                    <img class="w-100 h-100 rounded-circle o_object_fit_cover o_redirect"
                        t-att-src="props.message.author.avatarUrl"
                        t-att-class="{ 'cursor-pointer': props.hasActions and props.message.author.isCurrentUser }"
                        t-on-click="openChatAvatar" />
                    <PartnerImStatus partner="props.message.author" className="'position-absolute bottom-0 end-0'"/>
                </div>
            </div>
            <div class="overflow-auto" t-att-class="{ 'flex-grow-1': state.isEditing }">
                <div t-if="!props.squashed" class="o-mail-msg-header d-flex flex-wrap align-items-baseline">
                    <span class="o-mail-own-name">
                        <strong class="o_redirect me-1 text-truncate" t-att-class="{ 'cursor-pointer': props.hasActions and props.message.author.isCurrentUser }" t-on-click="openChatAvatar">
                        <t t-esc="message.author.name"/>
                        </strong> -
                    </span>
                    <small class="text-muted opacity-50 ms-2" t-att-title="props.message.dateTimeStr">
                        <RelativeTime datetime="props.message.dateTime" />
                    </small>

                    <small t-if="!isOriginThread" t-on-click.prevent="openRecord" class="o-mail-message-recod-name ms-1 text-500">
                        <t t-if="props.message.resModel !== 'mail.channel'">
                            on <a t-att-href="props.message.url"><t t-esc="props.message.recordName"/></a>
                        </t>
                        <t t-if="props.message.resModel === 'mail.channel'">
                            (from <a t-att-href="props.message.url">#<t t-esc="props.message.recordName"/></a>)
                        </t>
                    </small>
                </div>
                <div t-if="!state.isEditing" class="o-mail-message-content d-flex">
                    <t t-if="props.message.type === 'notification'">
                        <t t-if="props.message.subtype_description">
                            <p class="mb-0"><t t-esc="props.message.subtype_description"/></p>
                        </t>
                        <t t-if="props.message.trackingValues.length">
                            <t t-call="mail.tracking_values"/>
                        </t>
                        <div t-if="props.message.body" class="o-mail-message-body text-break mb-0 px-3 bg-view">
                            <t t-out="props.message.body"/>
                        </div>
                    </t>
                    <t t-if="props.message.type !== 'notification' and !messaging.isMessageBodyEmpty(props.message)">
                        <div class="o-mail-message-bubble-wrap position-relative">
                            <div class="o-mail-message-bubble border rounded-end-3 rounded-bottom-3 position-absolute top-0 start-0 w-100 h-100" t-att-class="{
                                    'bg-info-light border-info': !props.message.isAuthor,
                                    'bg-success-light border-success opacity-25': props.message.isAuthor,
                                }"/>
                            <div class="position-relative" t-att-class="{
                                'p-1': props.message.isNote,
                                'o-mail-message-body align-self-start text-break mb-0 rounded-end-3 rounded-bottom-3 p-3': !props.message.isNote,
                                'flex-grow-1': state.isEditing,
                            }">
                                <t t-out="props.message.body"/>
                            </div>
                        </div>
                    </t>
                    <div t-if="props.hasActions and !props.message.isTransient" class="o-mail-message-actions invisible">
                        <div class="rounded-1 shadow-sm">
                            <i class="cursor-pointer px-1 py-2 fa fa-lg"
                                t-att-class="props.message.isStarred ? 'fa-star' : 'fa-star-o'"
                                t-on-click="toggleStar"
                                role="button" tabindex="0" title="Mark as Todo" aria-label="Mark as Todo"/>
                            <i class="cursor-pointer px-1 py-2 fa fa-lg fa-trash" t-if="canBeDeleted" t-on-click="onClickDelete"
                                role="button" tabindex="0" title="Delete" aria-label="Delete"/>
                            <i class="cursor-pointer px-1 py-2 fa fa-lg fa-pencil" t-if="canBeEdited" t-on-click="onClickEdit"
                                role="button" tabindex="1" title="Edit" aria-label="Edit"/>
                            <i class="cursor-pointer px-1 py-2 fa fa-lg fa-reply" t-if="canReplyTo" t-on-click.stop="onClickReplyTo"
                                role="button" tabindex="1" title="Reply" aria-label="Reply"/>
                        </div>
                    </div>
                </div>
                <div t-else="" class="o-mail-message-editable-content flex-grow-1" t-att-class="{
                    'p-1': props.message.isNote,
                    'o-mail-message-body text-break mb-0 rounded-end-3 rounded-bottom-3 border p-3': !props.message.isNote,
                }">
                    <Composer autofocus="true" composer="props.message.composer" onDiscardCallback.bind="exitEditMode" onPostCallback.bind="exitEditMode" mode="'compact'"/>
                </div>
                <AttachmentList
                    t-if="props.message.attachments.length > 0"
                    attachments="props.message.attachments"
                    unlinkAttachment.bind="onClickAttachmentUnlink"
                    imagesHeight="300" />
                <LinkPreviewList t-if="props.message.linkPreviews" linkPreviews="props.message.linkPreviews" canBeDeleted="canBeDeleted" />
            </div>
        </div>
    </div>
</t>

<t t-name="mail.tracking_values" owl="1">
    <ul class="mb-0 ps-4">
        <t t-foreach="props.message.trackingValues" t-as="trackingValue" t-key="trackingValue.id">
            <li>
                <span class="fw-bold" t-esc="trackingValue.oldValue.value"/>
                <i class="fa fa-long-arrow-right mx-1 text-600" />
                <span class="text-info fw-bold" t-esc="trackingValue.newValue.value"/> (<t t-esc="trackingValue.changedField"/>)
            </li>
        </t>
    </ul>
</t>
</templates>
