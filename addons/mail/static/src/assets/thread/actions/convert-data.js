/** @odoo-module **/

import { Define } from '@mail/define';

export default Define`
    {Record/insert}
        [Record/models]
            Action
        [Action/name]
            Thread/convertData
        [Action/params]
            data
                [type]
                    Object
        [Action/returns]
            Object
        [Action/behavior]
            :data2
                {Record/insert}
                    [Record/models]
                        Object
            {if}
                @data
                .{Dict/hasKey}
                    avatarCacheKey
            .{then}
                {Record/update}
                    [0]
                        @data2
                    [1]
                        [Thread/avatarCacheKey]
                            @data
                            .{Dict/get}
                                avatarCacheKey
            {if}
                @data
                .{Dict/hasKey}
                    defaultDisplayMode
            .{then}
                {Record/update}
                    [0]
                        @data2
                    [1]
                        [Thread/defaultDisplayMode]
                            @data
                            .{Dict/get}
                                defaultDisplayMode
            {if}
                @data
                .{Dict/hasKey}
                    description
            .{then}
                {Record/update}
                    [0]
                        @data2
                    [1]
                        [Thread/description]
                            @data
                            .{Dict/get}
                                description
            {if}
                @data
                .{Dict/hasKey}
                    model
            .{then}
                {Record/update}
                    [0]
                        @data2
                    [1]
                        [Thread/model]
                            @data
                            .{Dict/get}
                                model
            {if}
                @data
                .{Dict/hasKey}
                    channel_type
            .{then}
                {Record/update}
                    [0]
                        @data2
                    [1]
                        [Thread/channelType]
                            @data
                            .{Dict/get}
                                channel_type
                        [Thread/model]
                            mail.channel
            {if}
                @data
                .{Dict/hasKey}
                    create_uid
            .{then}
                {Record/update}
                    [0]
                        @data2
                    [1]
                        [Thread/creator]
                            {Record/insert}
                                [Record/models]
                                    User
                                [User/id]
                                    @data
                                    .{Dict/get}
                                        create_uid
            {if}
                @data
                .{Dict/hasKey}
                    custom_channel_name
            .{then}
                {Record/update}
                    [0]
                        @data2
                    [1]
                        [Thread/customChannelName]
                            @data
                            .{Dict/get}
                                custom_channel_name
            {if}
                @data
                .{Dict/hasKey}
                    group_based_subscription
            .{then}
                {Record/update}
                    [0]
                        @data2
                    [1]
                        [Thread/isGroupBasedSubscription]
                            @data
                            .{Dict/get}
                                group_based_subscription
            {if}
                @data
                .{Dict/hasKey}
                    guestMembers
            .{then}
                {Record/update}
                    [0]
                        @data2
                    [1]
                        [Thread/guestMembers]
                            @data
                            .{Dict/get}
                                guestMembers
            {if}
                @data
                .{Dict/hasKey}
                    id
            .{then}
                {Record/update}
                    [0]
                        @data2
                    [1]
                        [Thread/id]
                            @data
                            .{Dict/get}
                                id
            {if}
                @data
                .{Dict/hasKey}
                    invitedGuests
            .{then}
                {Record/update}
                    [0]
                        @data2
                    [1]
                        [Thread/invitedGuests]
                            @data
                            .{Dict/get}
                                invitedGuests
            {if}
                @data
                .{Dict/hasKey}
                    invitedPartners
            .{then}
                {Record/update}
                    [0]
                        @data2
                    [1]
                        [Thread/invitedPartners]
                            @data
                            .{Dict/get}
                                invitedPartners
            {if}
                @data
                .{Dict/hasKey}
                    is_minimized
                .{&}
                    @data
                    .{Dict/hasKey}
                        state
            .{then}
                {Record/update}
                    [0]
                        @data2
                    [1]
                        [Thread/serverFoldState]
                            {if}
                                @data
                                .{Dict/get}
                                    is_minimized
                            .{then}
                                @data
                                .{Dict/get}
                                    state
                            .{else}
                                closed
            {if}
                @data
                .{Dict/hasKey}
                    is_pinned
            .{then}
                {Record/update}
                    [0]
                        @data2
                    [1]
                        [Thread/isServerPinned]
                            @data
                            .{Dict/get}
                                is_pinned
            {if}
                @data
                .{Dict/hasKey}
                    last_interest_dt
                .{&}
                    @data
                    .{Dict/get}
                        last_interest_dt
            .{then}
                {Record/update}
                    [0]
                        @data2
                    [1]
                        [Thread/lastInterestDateTime]
                            {String/toDatetime}
                                @data
                                .{Dict/get}
                                    last_interest_dt
            {if}
                @data
                .{Dict/hasKey}
                    last_message
                .{&}
                    @data
                    .{Dict/get}
                        last_message
            .{then}
                :messageData
                    {Message/convertData}
                        [Message/id]
                            @data
                            .{Dict/get}
                                last_message
                            .{Dict/get}
                                id
                        [Message/model]
                            @data2
                            .{Thread/model}
                        [Message/res_id]
                            @data2
                            .{Thread/id}
                {Record/update}
                    [0]
                        @data2
                    [1]
                        [Thread/serverLastMessage]
                            {Record/insert}
                                [Record/models]
                                    Message
                                @messageData
            {if}
                @data
                .{Dict/hasKey}
                    last_message_id
                .{&}
                    @data
                    .{Dict/get}
                        last_message_id
            .{then}
                :messageData
                    {Message/convertData}
                        [Message/id]
                            @data
                            .{Dict/get}
                                last_message_id
                        [Message/model]
                            @data2
                            .{Thread/model}
                        [Message/res_id]
                            @data2
                            .{Thread/id}
                {Record/update}
                    [0]
                        @data2
                    [1]
                        [Thread/serverLastMessage]
                            {Record/insert}
                                [Record/models]
                                    Message
                                @messageData
            {if}
                @data
                .{Dict/hasKey}
                    memberCount
            .{then}
                {Record/update}
                    [0]
                        @data2
                    [1]
                        [Thread/memberCount]
                            @data
                            .{Dict/get}
                                memberCount
            {if}
                @data
                .{Dict/hasKey}
                    message_needaction_counter
            .{then}
                {Record/update}
                    [0]
                        @data2
                    [1]
                        [Thread/messageNeedactionCounter]
                            @data
                            .{Dict/get}
                                message_needaction_counter
            {if}
                @data
                .{Dict/hasKey}
                    message_unread_counter
            .{then}
                {Record/update}
                    [0]
                        @data2
                    [1]
                        [Thread/serverMessageUnreadCounter]
                            @data
                            .{Dict/get}
                                message_unread_counter
            {if}
                @data
                .{Dict/hasKey}
                    name
            .{then}
                {Record/update}
                    [0]
                        @data2
                    [1]
                        [Thread/name]
                            @data
                            .{Dict/get}
                                name
            {if}
                @data
                .{Dict/hasKey}
                    public
            .{then}
                {Record/update}
                    [0]
                        @data2
                    [1]
                        [Thread/public]
                            @data
                            .{Dict/get}
                                public
            {if}
                @data
                .{Dict/hasKey}
                    seen_message_id
            .{then}
                {Record/update}
                    [0]
                        @data2
                    [1]
                        [Thread/lastSeenByCurrentPartnerMessageId]
                            @data
                            .{Dict/get}
                                seen_message_id
                            .{|}
                                0
            {if}
                @data
                .{Dict/hasKey}
                    uuid
            .{then}
                {Record/update}
                    [0]
                        @data2
                    [1]
                        [Thread/uuid]
                            @data
                            .{Dict/get}
                                uuid
            {Dev/comment}
                relations
            {if}
                @data
                .{Dict/hasKey}
                    members
            .{then}
                {if}
                    @data
                    .{Dict/get}
                        members
                    .{isFalsy}
                .{then}
                    {Record/update}
                        [0]
                            @data2
                        [1]
                            [Thread/members]
                                {Record/empty}
                .{else}
                    {Record/update}
                        [0]
                            @data2
                        [1]
                            [Thread/members]
                                @data
                                .{Dict/get}
                                    members
                                .{Collection/map}
                                    {Record/insert}
                                        [Record/models]
                                            Function
                                        [Function/in]
                                            item
                                        [Function/out]
                                            {Record/insert}
                                                [Record/models]
                                                    Partner
                                                {Partner/convertData}
                                                    @item
            {if}
                @data
                .{Dict/hasKey}
                    rtc_inviting_session
            .{then}
                {Record/update}
                    [0]
                        @data2
                    [1]
                        [Thread/rtcInvitingSession]
                            {Record/insert}
                                [Record/models]
                                    RtcSession
                                @data
                                .{Dict/get}
                                    rtc_inviting_session
            {if}
                @data
                .{Dict/hasKey}
                    rtcSessions
            .{then}
                {Record/update}
                    [0]
                        @data2
                    [1]
                        [Thread/rtcSessions]
                            @data
                            .{Dict/get}
                                rtcSessions
            {if}
                @data
                .{Dict/hasKey}
                    seen_partners_info
            .{then}
                {if}
                    @data
                    .{Dict/get}
                        seen_partners_info
                    .{isFalsy}
                .{then}
                    {Record/update}
                        [0]
                            @data2
                        [1]
                            [Thread/partnerSeenInfos]
                                {Record/empty}
                .{else}
                    {Record/update}
                        [0]
                            @data2
                        [1]
                            [Thread/partnerSeenInfos]
                                @data
                                .{Dict/get}
                                    seen_partners_info
                                .{Collection/map}
                                    {Record/insert}
                                        [Record/models]
                                            Function
                                        [Function/in]
                                            item
                                        [Function/out]
                                            {Record/insert}
                                                [Record/models]
                                                    ThreadPartnerSeenInfo
                                                [ThreadPartnerSeenInfo/lastFetchedMessage]
                                                    {if}
                                                        @item
                                                        .{Dict/get}
                                                            fetched_message_id
                                                    .{then}
                                                        {Record/insert}
                                                            [Record/models]
                                                                Message
                                                            [Message/id]
                                                                @item
                                                                .{Dict/get}
                                                                    fetched_message_id
                                                    .{else}
                                                        {Record/empty}
                                                [ThreadPartnerSeenInfo/lastSeenMessage]
                                                    {if}
                                                        @item
                                                        .{Dict/get}
                                                            seen_message_id
                                                    .{then}
                                                        {Record/insert}
                                                            [Record/models]
                                                                Message
                                                            [Message/id]
                                                                @item
                                                                .{Dict/get}
                                                                    seen_message_id
                                                    .{else}
                                                        {Record/empty}
                                                [ThreadPartnerSeenInfo/partner]
                                                    {Record/insert}
                                                        [Record/models]
                                                            Partner
                                                        [Partner/id]
                                                            @item
                                                            .{Dict/get}
                                                                partner_id
                    {if}
                        @data
                        .{Dict/get}
                            id
                    .{then}
                        :messageIds
                            @data
                            .{Dict/get}
                                seen_partners_info
                            .{Collection/reduce}
                                [0]
                                    {Record/insert}
                                        [Record/models]
                                            Function
                                        [Function/in]
                                            acc
                                            item
                                        [Function/out]
                                            {if}
                                                @item
                                                .{Dict/get}
                                                    fetched_message_id
                                            .{then}
                                                {Set/add}
                                                    [0]
                                                        @acc
                                                    [1]
                                                        @item
                                                        .{Dict/get}
                                                            fetched_message_id
                                            {if}
                                                @item
                                                .{Dict/get}
                                                    seen_message_id
                                            .{then}
                                                {Set/add}
                                                    [0]
                                                        @acc
                                                    [1]
                                                        @item
                                                        .{Dict/get}
                                                            seen_message_id
                                            @currentSet
                                [1]
                                    {Record/insert}
                                        [Record/models]
                                            Set
                        {if}
                            @messageIds
                            .{Collection/size}
                            .{>}
                                0
                        .{then}
                            {Record/update}
                                [0]
                                    @data2
                                [1]
                                    [Thread/messageSeenIndicators]
                                        @messageIds
                                        .{Collection/map}
                                            {Record/insert}
                                                [Record/models]
                                                    Function
                                                [Function/in]
                                                    item
                                                [Function/out]
                                                    {Record/insert}
                                                        [Record/models]
                                                            MessageSeenIndicator
                                                        [MessageSeenIndicator/message]
                                                            {Record/insert}
                                                                [Record/models]
                                                                    Message
                                                                [Message/id]
                                                                    @item
            @data2
`;
