/** @odoo-module **/

import { Define } from '@mail/define';

export default Define`
    {Record/insert}
        [Record/models]
            Action
        [Action/name]
            Composer/detectSuggestionDelimiter
        [Action/params]
            composer
        [Action/behavior]
            {if}
                @composer
                .{Composer/textInputCursorStart}
                .{!=}
                    @composer
                    .{Composer/textInputCursorEnd}
            .{then}
                {break}
            :lastInputChar
                @composer
                .{Composer/textInputContent}
                .{String/substring}
                    [0]
                        @composer
                        .{Composer/textInputCursorStart}
                        .{-}
                            1
                    [1]
                        @composer
                        .{Composer/textInputCursorStart}
            {if}
                {Record/insert}
                    [Record/models]
                        Collection
                    {String/atSign}
                    {String/colonSign}
                    #
                    /
                .{Collection/includes}
                    @lastInputChar
                .{&}
                    @composer
                    .{Composer/hasSuggestions}
                    .{isFalsy}
            .{then}
                {Record/update}
                    [0]
                        @composer
                    [1]
                        [Composer/suggestionDelimiter]
                            @lastInputChar
            :mentionKeyword
                {Composer/_validateMentionKeyword}
                    [0]
                        @composer
                    [1]
                        false
            {if}
                @mentionKeyword
                .{!=}
                    false
            .{then}
                {switch}
                    @composer
                    .{Composer/suggestionDelimiter}
                .{case}
                    [@]
                        {Record/update}
                            [0]
                                @composer
                            [1]
                                [Composer/activeSuggestedRecordName]
                                    activeSuggestedPartner
                                [Composer/extraSuggestedRecordsListName]
                                    extraSuggestedPartners
                                [Composer/mainSuggestedRecordsListName]
                                    mainSuggestedPartners
                                [Composer/suggestionModelName]
                                    Partner
                        {Composer/_executeOrQueueFunction}
                            [0]
                                @composer
                            [1]
                                {Composer/_updateSuggestedPartners}
                                    [0]
                                        @composer
                                    [1]
                                        @mentionKeyword
                    [:]
                        {Record/update}
                            [0]
                                @composer
                            [1]
                                [Composer/activeSuggestedRecordName]
                                    activeSuggestedCannedResponse
                                [Composer/mainSuggestedRecordsListName]
                                    suggestedCannedResponses
                                [Composer/suggestionModelName]
                                    CannedResponse
                        {Composer/_executeOrQueueFunction}
                            [0]
                                @composer
                            [1]
                                {Composer/_updateSuggestedCannedResponses}
                                    [0]
                                        @composer
                                    [1]
                                        @mentionKeyword
                    [/]
                        {Record/update}
                            [0]
                                @composer
                            [1]
                                [Composer/activeSuggestedRecordName]
                                    activeSuggestedChannelCommand
                                [Composer/mainSuggestedRecordsListName]
                                    suggestedChannelCommands
                                [Composer/suggestionModelName]
                                    ChannelCommand
                        {Composer/_executeOrQueueFunction}
                            [0]
                                @composer
                            [1]
                                {Composer/_updateSuggestedChannelCommands}
                                    [0]
                                        @composer
                                    [1]
                                        @mentionKeyword
                    [#]
                        {Record/update}
                            [0]
                                @composer
                            [1]
                                [Composer/activeSuggestedRecordName]
                                    activeSuggestedChannel
                                [Composer/mainSuggestedRecordsListName]
                                    suggestedChannels
                                [Composer/suggestionModelName]
                                    Thread
                        {Composer/_executeOrQueueFunction}
                            [0]
                                @composer
                            [1]
                                {Composer/_updateSuggestedChannels}
                                    [0]
                                        @composer
                                    [1]
                                        @mentionKeyword
            .{else}
                {Composer/closeSuggestions}
                    @composer
`;
