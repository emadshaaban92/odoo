/** @odoo-module **/

import { Define } from '@mail/define';

export default Define`
    {Record/insert}
        [Record/models]
            onChange
        [onChange/name]
            onThreadCacheIsLoadingChanged
        [onChange/model]
            ThreadView
        [onChange/dependencies]
            ThreadView/threadCache
            .ThreadCache/isLoading
        [onChange/behavior]
            {if}
                @record
                .{ThreadView/threadCache}
                .{?}
                    .{ThreadCache/isLoading}
            .{then}
                {if}
                    @record
                    .{ThreadView/isLoading}
                    .{isFalsy}
                    .{&}
                        @record
                        .{ThreadView/isPreparingLoading}
                        .{isFalsy}
                .{then}
                    {Record/update}
                        [0]
                            @record
                        [1]
                            [ThreadView/isPreparingLoading]
                                true
                    {Record/doAsync}
                        []
                            @record
                        []
                            {Record/insert}
                                [Record/models]
                                    Promise
                                {Record/insert}
                                    [Record/models]
                                        Function
                                    [Function/in]
                                        resolve
                                    [Function/out]
                                        {Record/update}
                                            [0]
                                                @record
                                            [1]
                                                [ThreadView/loaderTimeout]
                                                    {web.Browser/setTimeout}
                                                        [0]
                                                            @resolve
                                                        [1]
                                                            {Env/loadingBaseDelayDuration}
                    .{Promise/then}
                        {Record/update}
                            [0]
                                @record
                            [1]
                                [ThreadView/isLoading]
                                    @record
                                    .{ThreadView/threadCache}
                                    .{?}
                                        .{ThreadCache/isLoading}
                                    .{??}
                                        false
                                [ThreadView/isPreparingLoading]
                                    false
            .{else}
                {web.Browser/clearTimeout}
                    @record
                    .{ThreadView/loaderTimeout}
                {Record/update}
                    [0]
                        @record
                    [1]
                        [ThreadView/isLoading]
                            false
                        [ThreadView/isPreparingLoading]
                            false
`;
