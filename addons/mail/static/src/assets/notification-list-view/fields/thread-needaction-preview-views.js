/** @odoo-module **/

import { Define } from '@mail/define';

export default Define`
    {Record/insert}
        [Record/models]
            Field
        [Field/name]
            threadNeedactionPreviewViews
        [Field/model]
            NotificationListView
        [Field/type]
            many
        [Field/target]
            ThreadNeedactionPreviewView
        [Field/isCausal]
            true
        [Field/inverse]
            ThreadNeedactionPreviewView/notificationListViewOwner
        [Field/compute]
            {if}
                @record
                .{NotificationListView/filter}
                .{!=}
                    all
            .{then}
                {Record/empty}
            .{else}
                {Record/all}
                    [Record/models]
                        Thread
                    [Thread/isNotMailbox]
                        true
                    [Thread/hasNeedactionMessagesAsOriginThread]
                        true
                .{Collection/sort}
                    {Record/insert}
                        [Record/models]
                            Function
                        [Function/in]
                            t1
                            t2
                        [Function/out]
                            {if}
                                @t1
                                .{Thread/hasNeedactionMessagesAsOriginThread}
                                .{&}
                                    @t2
                                    .{Thread/hasNeedactionMessagesAsOriginThread}
                                    .{isFalsy}
                            .{then}
                                -1
                            .{elif} 
                                @t1
                                .{Thread/hasNeedactionMessagesAsOriginThread}
                                .{isFalsy}
                                .{&}
                                    @t2
                                    .{Thread/hasNeedactionMessagesAsOriginThread}
                            .{then}
                                1
                            .{elif}
                                @t1
                                .{Thread/lastNeedactionMessageAsOriginThread}
                                .{&}
                                    @t2
                                    .{Thread/lastNeedactionMessageAsOriginThread}
                            .{then}
                                {if}
                                    @t1
                                    .{Thread/lastNeedactionMessageAsOriginThread}
                                    .{Message/id}
                                    .{<}
                                        @t2
                                        .{Thread/lastNeedactionMessageAsOriginThread}
                                        .{Message/id}
                                .{then}
                                    1
                                .{else}
                                    -1
                            .{elif}
                                @t1
                                .{Thread/lastNeedactionMessageAsOriginThread}
                            .{then}
                                -1
                            .{elif}
                                @t2
                                .{Thread/lastNeedactionMessageAsOriginThread}
                            .{then}
                                1
                            .{elif}
                                @t1
                                .{Thread/id}
                                .{<}
                                    @t2
                                    .{Thread/id}
                            .{then}
                                -1
                            .{else}
                                1
                .{Collection/map}
                    {Record/insert}
                        [Record/models]
                            Function
                        [Function/in]
                            thread
                        [Function/out]
                            {Record/insert}
                                [Record/models]
                                    ThreadNeedactionPreviewView
                                [ThreadNeedactionPreviewView/thread]
                                    @thread
`;
