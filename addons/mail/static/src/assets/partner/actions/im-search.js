/** @odoo-module **/

import { Define } from '@mail/define';

export default Define`
    {Dev/comment}
        Search for partners matching 'keyword'.
    {Record/insert}
        [Record/models]
            Action
        [Action/name]
            Partner/imSearch
        [Action/params]
            callback
                [type]
                    Function
            keyword
                [type]
                    String
            limit
                [type]
                    Integer
                [default]
                    10
            record
                [type]
                    Partner
        [Action/behavior]
            {Dev/comment}
                prefetched partners
            :partners
                {Record/insert}
                    [Record/models]
                        Collection
            :cleanedSearchTerm
                {Utils/cleanSearchTerm}
                    @keyword
            {foreach}
                {Record/all}
                    [Record/models]
                        Partner
                    {Record/insert}
                        [Record/models]
                            Function
                        [Function/in]
                            item
                        [Function/out]
                            @item
                            .{Partner/active}
            .{as}
                partner
            .{do}
                {if}
                    @partners
                    .{Collection/length}
                    .{<}
                        @limit
                .{then}
                    {if}
                        @partner
                        .{!=}
                            {Env/currentPartner}
                        .{&}
                            @partner
                            .{Partner/name}
                        .{&}
                            @partner
                            .{Partner/user}
                        .{&}
                            {Utils/cleanSearchTerm}
                                @partner
                                .{Partner/name}
                            .{String/includes}
                                @cleanedSearchTerm
                    .{then}
                        {Collection/push}
                            [0]
                                @partners
                            [1]
                                @partner
            {if}
                @partners
                .{Collection/length}
                .{=}
                    0
            .{then}
                :partnersData
                    @env
                    .{Env/owlEnv}
                    .{Dict/get}
                        services
                    .{Dict/get}
                        rpc
                    .{Function/call}
                        [0]
                            [model]
                                res.partner
                            [method]
                                im_search
                            [args]
                                {Record/insert}
                                    [Record/models]
                                        Collection
                                    [0]
                                        @keyword
                                    [1]
                                        @limit
                        [1]
                            [shadow]
                                true
                :newPartners
                    {Record/insert}
                        [Record/models]
                            Partner
                        @partnersData
                        .{Collection/map}
                            {Record/insert}
                                [Record/models]
                                    Function
                                [Function/in]
                                    item
                                [Function/out]
                                    {Partner/convertData}
                                        @item
                {Collection/push}
                    [0]
                        @partners
                    [1]
                        @newPartners
            @callback
            .{Function/call}
                @partners
`;
