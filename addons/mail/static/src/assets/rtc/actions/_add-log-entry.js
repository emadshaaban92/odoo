/** @odoo-module **/

import { Define } from '@mail/define';

export default Define`
    {Record/insert}
        [Record/models]
            Action
        [Action/name]
            Rtc/_addLogEntry
        [Action/params]
            token
                [type]
                    String
            entry
                [type]
                    String
            error
                [type]
                    Error
            step
                [type]
                    String
                [description]
                    current step of the flow
            state
                [type]
                    String
                [description]
                    current state of the connection
            record
                [type]
                    Rtc
        [Action/behavior]
            {if}
                {Env/isDebug}
                .{isFalsy}
            .{then}
                {break}
            {if}
                @record
                .{Rtc/logs}
                .{Dict/hasKey}
                    @token
                .{isFalsy}
            .{then}
                {Record/update}
                    [0]
                        @record
                        .{Rtc/logs}
                    [1]
                        {entry}
                            [key]
                                @token
                            [value]
                                [step]
                                    {String/empty}
                                [state]
                                    {String/empty}
                                [logs]
                                    {Record/insert}
                                        [Record/models]
                                            Collection
            :trace
                {web.Browser/Error}
                .{web.Error/stack}
            {Collection/push}
                [0]
                    @record
                    .{Rtc/logs}
                    .{Collection/at}
                        @token
                    .{Dict/get}
                        logs
                [1]
                    [event]
                        {Record/insert}
                            [Record/models]
                                web.Moment
                        .{web.Moment/format}
                            h:mm:ss
                        .{+}
                            : 
                        .{+}
                            @entry
                    [error]
                        {if}
                            @error
                        .{then}
                            {Record/insert}
                                [Record/models]
                                    Object
                                [name]
                                    @error
                                    .{Error/name}
                                [message]
                                    @error
                                    .{Error/message}
                                [stack]
                                    @error
                                    .{Error/stack}
                                    .{&}
                                        @error
                                        .{Error/stack}
                                        .{String/split}
                                            \n
                    [trace]
                        @trace
                        .{String/split}
                            \n
                        .{Collection/slice}
                            1
                            15
            {if}
                @step
            .{then}
                {Record/update}
                    [0]
                        @record
                        .{Rtc/logs}
                        .{Dict/get}
                            token
                    [1]
                        [step]
                            @step
            {if}
                @state
            .{then}
                {Record/update}
                    [0]
                        @record
                        .{Rtc/logs}
                        .{Dict/get}
                            token
                    [1]
                        [state]
                            @state
`;
