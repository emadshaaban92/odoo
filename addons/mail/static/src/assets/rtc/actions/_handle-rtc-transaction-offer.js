/** @odoo-module **/

import { Define } from '@mail/define';

export default Define`
    {Record/insert}
        [Record/models]
            Action
        [Action/name]
            Rtc/_handleRtcTransactionOffer
        [Action/params]
            fromToken
                [type]
                    String
            sdp
                [type]
                    Object
                [description]
                    Session Description Protocol
            record
                [type]
                    Rtc
        [Action/behavior]
            :peerConnection
                @record
                .{Rtc/_peerConnections}
                .{Collection/at}
                    @fromToken
                .{|}
                    {Rtc/_createPeerConnection}
                        [0]
                            @record
                        [1]
                            @fromToken
            {if}
                @peerConnection
                .{isFalsy}
                .{|}
                    {Set/has}
                        [0]
                            @record
                            .{Rtc/invalidIceConnectionStates}
                        [1]
                            peerConnection
                            .{RTCPeerConnection/connectionState}
            .{then}
                {break}
            {if}
                @peerConnection
                .{RTCPeerConnection/signalingState}
                .{=}
                    have-remote-offer
            .{then}
                {Dev/comment}
                    we already have an offer
                {break}
            :rtcSessionDescription
                {Record/insert}
                    [Record/models]
                        RTCSessionDescription
                    @sdp
            {try}
                {RTCPeerConnection/setRemoteDescription}
                    [0]
                        @peerConnection
                    [1]
                        @rtcSessionDescription
            .{catch}
                {Record/insert}
                    [Record/models]
                        Function
                    [Function/in]
                        error
                    [Function/out]
                        {Rtc/_addLogEntry}
                            [0]
                                @record
                            [1]
                                @fromToken
                            [2]
                                offer handling: failed at setting remoteDescription
                            [3]
                                [error]
                                    @error
                        {break}
            {Rtc/_updateRemoteTrack}
                [0]
                    @record
                [1]
                    @peerConnection
                [2]
                    audio
                [3]
                    [token]
                        @fromToken
            {Rtc/_updateRemoteTrack}
                [0]
                    @record
                [1]
                    @peerConnection
                [2]
                    video
                [3]
                    [token]
                        @fromToken
            {Rtc/_addLogEntry}
                [0]
                    @record
                [1]
                    @fromToken
                [2]
                    sending notification: answer
                [3]
                    [step]
                        sending answer
            {try}
                :answer
                    {RTCPeerConnection/createAnswer}
                        @peerConnection
            .{catch}
                {Rtc/_addLogEntry}
                    [0]
                        @record
                    [1]
                        @fromToken
                    [2]
                        offer handling: failed at creating answer
                    [3]
                        [error]
                            @error
                {break}
            {try}
                {RTCPeerConnection/setLocalDescription}
                    [0]
                        @peerConnection
                    [1]
                        @answer
            .{catch}
                {Rtc/_addLogEntry}
                    [0]
                        @record
                    [1]
                        @fromToken
                    [2]
                        offer handling: failed at setting localDescription
                    [3]
                        [error]
                            @error
                {break}
            {Rtc/_notifyPeers}
                [0]
                    @record
                [1]
                    @fromToken
                [2]
                    [event]
                        answer
                    [payload]
                        [sdp]
                            @peerConnection
                            .{RTCPeerConnection/localDescription}
            {Rtc/_recoverConnection}
                [0]
                    @record
                [1]
                    @fromToken
                [2]
                    [delay]
                        @record
                        .{Rtc/recoveryTimeout}
                    [reason]
                        standard answer timeout
`;
