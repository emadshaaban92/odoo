/** @odoo-module **/

import { Define } from '@mail/define';

export default Define`
    :BASE_VISUAL
        {Dev/comment}
            Amount of visible slots available for chat windows.
        [Visual/availableVisibleSlots]
            0
        {Dev/comment}
            Data related to the hidden menu.
        [Visual/hidden]
            {Dev/comment}
                List of hidden docked chat windows. Useful to compute counter.
                Chat windows are ordered by their 'chatWindows' order.
            [Hidden/chatWindows]
                {Record/insert}
                    [Record/models]
                        Collection
            {Dev/comment}
                Whether hidden menu is visible or not
            [Hidden/isVisible]
                false
            {Dev/comment}
                Offset of hidden menu starting point from the starting point
                of chat window manager. Makes only sense if it is visible.
            [Hidden/offset]
                0
        {Dev/comment}
            Data related to visible chat windows. Index determine order of
            docked chat windows.

            Value:

            {
                chatWindowLocalId,
                offset,
            }

            Offset is offset of starting point of docked chat window from
            starting point of dock chat window manager. Docked chat windows
            are ordered by their 'chatWindows' order
        [Visual/visible]
            {Record/insert}
                [Record/models]
                    Collection
    {Dev/comment}
        AKU TODO: split in many fields
    {Record/insert}
        [Record/models]
            Field
        [Field/name]
            visual
        [Field/model]
            ChatWindowManager
        [Field/type]
            attr
        [Field/default]
            @BASE_VISUAL
        [Field/compute]
            :visual
                {JSON/parse}
                    {JSON/stringify}
                        @BASE_VISUAL
            :BETWEEN_GAP_WIDTH
                5
            :CHAT_WINDOW_WIDTH
                325
            :END_GAP_WIDTH
                {if}
                    {Device/isMobile}
                .{then}
                    0
                .{else}
                    10
            :GLOBAL_WINDOW_WIDTH
                {Device/globalWindowInnerWidth}
            :HIDDEN_MENU_WIDTH
                200
                {Dev/comment}
                    max width, including width of dropup list items
            :START_GAP_WIDTH
                {if}
                    {Device/isMobile}
                .{then}
                    0
                .{else}
                    10
            {if}
                {Device/isMobile}
                .{isFalsy}
                .{&}
                    {Discuss/discussView}
            .{then}
                @visual
                {break}
            {if}
                @record
                .{ChatWindowManager/allOrdered}
                .{Collection/length}
                .{=}
                    0
            .{then}
                @visual
                {break}
            :relativeGlobalWindowWidth
                @GLOBAL_WINDOW_WIDTH
                .{-}
                    @START_GAP_WIDTH
                .{-}
                    @END_GAP_WIDTH
            :maxAmountWithoutHidden
                {Math/floor}
                    @relativeGlobalWindowWidth
                    .{/}
                        @CHAT_WINDOW_WIDTH
                        .{+}
                            @BETWEEN_GAP_WIDTH
            :maxAmountWithoutHidden
                {Math/floor}
                    (
                        @relativeGlobalWindowWidth
                        .{-}
                            @HIDDEN_MENU_WIDTH
                        .{-}
                            @BETWEEN_GAP_WIDTH
                        .{/}
                            @CHAT_WINDOW_WIDTH
                            .{+}
                                @BETWEEN_GAP_WIDTH
            {if}
                {Device/isMobile}
            .{then}
                :maxAmountWithoutHidden
                    1
                :maxAmountWithHidden
                    1
            {if}
                @record
                .{ChatWindowManager/allOrdered}
                .{Collection/length}
                .{<=}
                    @maxAmountWithoutHidden
            .{then}
                {foreach}
                    @record
                    .{ChatWindowManager/allOrdered}
                .{as}
                    [index]
                        index
                .{do}
                    {Record/update}
                        [0]
                            @visual
                            .{Visual/visible}
                        [1]
                            [Visible/ChatWindow]
                                @record
                                .{ChatWindowManager/allOrdered'}
                                .{Collection/at}
                                    @index
                            [Visible/offset]
                                @START_GAP_WIDTH
                                .{+}
                                    @index
                                    .{*}
                                        @CHAT_WINDOW_WIDTH
                                        .{+}
                                            @BETWEEN_GAP_WIDTH
                {Record/update}
                    [0]
                        @visual
                    [1]
                        [Visual/availableVisibleSlots]
                            @maxAmountWithoutHidden
            .{elif}
                @maxAmountWithHidden
                .{>}
                    0
            .{then}
                {Dev/comment}
                    some visible, some hidden
                {foreach}
                    {Record/insert}
                        [Record/models]
                            IntegerSequence
                        [start]
                            0
                        [end]
                            @maxAmountWithHidden
                .{as}
                    index
                .{do}
                    {Record/update}
                        [0]
                            @visual
                        [1]
                            [Visual/visible]
                                {Record/insert}
                                    [Record/models]
                                        Visible
                                    [Visible/chatWindow]
                                        @record
                                        .{ChatWindowManager/allOrdered}
                                        .{Collection/at}
                                            @index
                                    [Visible/offset]
                                        @START_GAP_WIDTH
                                        .{+}
                                            @index
                                            .{*}
                                                @CHAT_WINDOW_WIDTH
                                                .{+}
                                                    @BETWEEN_GAP_WIDTH
                {if}
                    @record
                    .{ChatWindowManager/allOrdered}
                    .{Collection/length}
                    .{>}
                        @maxAmountWithHidden
                .{then}
                    {Record/update}
                        [0]
                            @visual
                            .{Visual/hidden}
                        [1]
                            [Hidden/isVisible]
                                {Device/isMobile}
                                .{isFalsy}
                            [Hidden/offset]
                                @visual
                                .{Visual/visible}
                                .{Collection/at}
                                    @maxAmountWithHidden
                                    .{-}
                                        1
                                .{Visible/offset}
                                .{+}
                                    @CHAT_WINDOW_WIDTH
                                .{+}
                                    @BETWEEN_GAP_WIDTH
                {foreach}
                    @record
                    .{ChatWindowManager/allOrdered}
                .{as}
                    chatWindow
                .{do}
                    {if}
                        @record
                        .{ChatWindowManager/allOrdered}
                        .{Collection/filter}
                            {Record/insert}
                                [Record/models]
                                    Function
                                [Function/in]
                                    item
                                [Function/out]
                                    @item
                                    .{ChatWindow/allOrderedSelfIndex}
                                    .{>=}
                                        @maxAmountWithHidden
                        .{Collection/includes}
                            @chatWindow
                        .{isFalsy}
                    .{then}
                        {continue}
                    {Record/update}
                        [0]
                            @visual
                            .{Visual/hidden}
                        [1]
                            [Hidden/chatWindows]
                                {Field/add}
                                    @chatWindow
                {Record/update}
                    [0]
                        @visual
                    [1]
                        [Visual/availableVisibleSlots]
                            @maxAmountWithHidden
            .{else}
                {Dev/comment}
                    all hidden
                {Record/update}
                    [0]
                        @visual
                        .{Visual/hidden}
                    [1]
                        [Hidden/isVisible]
                            {Device/isMobile}
                            .{isFalsy}
                        [Hidden/offset]
                            @START_GAP_WIDTH
                        [Hidden/chatWindows]
                            @record
                            .{ChatWindowManager/allOrdered}
                {Console/warn}
                    cannot display any visible chat windows (screen is too small)
                {Record/update}
                    [0]
                        @visual
                    [1]
                        [Visual/availableVisibleSlots]
                            0
            @visual
`;
