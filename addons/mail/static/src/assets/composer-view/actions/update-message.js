/** @odoo-module **/

import { Define } from '@mail/define';

export default Define`
    {Dev/comment}
        Update a posted message when the message is ready.
    {Record/insert}
        [Record/models]
            Action
        [Action/name]
            ComposerView/updateMessage
        [Action/params]
            record
                [type]
                    ComposerView
        [Action/behavior]
            :composer
                @record
                .{ComposerView/composer}
            {if}
                @composer
                .{Composer/textInputContent}
                .{isFalsy}
            .{then}
                {Record/update}
                    [0]
                        @record
                        .{ComposerView/messageViewInEditing}
                        .{MessageView/messageActionList}
                    [1]
                        [MessageActionList/deleteConfirmDialog]
                            {Record/insert}
                                [Record/models]
                                    Dialog
                {break}
            :escapedAndCompactContent
                {Utils/escapeAndCompactTextContent}
                    @composer
                    .{Composer/textInputContent}
            :body
                @escapedAndCompactContent
                .{String/replace}
                    [0]
                        /&nbsp;/g
                    [1]
                        {String/whitespace}
                .{String/trim}
            :body
                {ComposerView/_generateMentionsLinks}
                    [0]
                        @record
                    [1]
                        @body
            :body
                {Utils/parseAndTransform}
                    [0]
                        @body
                    [1]
                        addLink
            :body
                {ComposerView/_generateEmojisOnHtml}
                    [0]
                        @record
                    [1]
                        @body
            :data
                {Record/insert}
                    [Record/models]
                        Object
                    [body]
                        @body
                    [attachment_ids]
                        @composer
                        .{Composer/attachments}
                        .{Collection/concat}
                            @record
                            .{ComposerView/messageViewInEditing}
                            .{MessageView/message}
                            .{Message/attachments}
                            .{Collection/map}
                                {Record/insert}
                                    [Record/models]
                                        Function
                                    [Function/in]
                                        attachment
                                    [Function/out]
                                        @attachment
                                        .{Attachment/id}
            {try}
                {Record/update}
                    [0]
                        @composer
                    [1]
                        [Composer/isPostingMessage]
                            true
                :messageViewInEditing
                    @record
                    .{ComposerView/messageViewInEditing}
                {Message/updateContent}
                    [0]
                        @messageViewInEditing
                        .{MessageView/message}
                    [1]
                        @data
                {if}
                    {Record/exists}
                        @messageViewInEditing
                .{then}
                    {MessageView/stopEditing}
                        @messageViewInEditing
            .{finally}
                {if}
                    {Record/exists}
                        @composer
                .{then}
                    {Record/update}
                        [0]
                            @composer
                        [1]
                            [Composer/isPostingMessage]
                                false
`;
