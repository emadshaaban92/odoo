/** @odoo-module **/

import { Define } from '@mail/define';

export default Define`
    {Dev/comment}
        Creates and download a file that contains the logs of the current RTC call.
    {Record/insert}
        [Record/models]
            Action
        [Action/name]
            RtcOptionList/onClickDownloadLogs
        [Action/params]
            ev
                [type]
                    MouseEvent
            record
                [type]
                    RtcOptionList
        [Action/behavior]
            :channel
                @record
                .{RtcOptionList/rtcController}
                .{RtcController/callViewer}
                .{RtcCallViewer/threadView}
                .{ThreadView/thread}
            {if}
                @record
                .{RtcOptionList/channel}
                .{Thread/rtc}
                .{isFalsy}
            .{then}
                {break}
            :data
                {JSON/stringify}
                    @channel
                    .{Thread/rtc}
                    .{Rtc/logs}
            :blob
                {Record/insert}
                    [Record/models]
                        Blob
                    [0]
                        @data
                    [1]
                        [type]
                            application/json
            :url
                {URL/createObjectURL}
                    [0]
                        {web.Env/browser}
                        .{web.Browser/URL}
                    [1]
                        @blob
            :a
                {Document/createElement}
                    a
            {Record/update}
                [0]
                    @a
                [1]
                    [web.Element/href]
                        @url
                    [web.Element/download]
                        RtcLogs_Channel
                        .{+}
                            @channel
                            .{Thread/id}
                        .{+}
                            _Session
                        .{+}
                            @channel
                            .{Thread/rtc}
                            .{Rtc/currentRtcSession}
                            .{RtcSession/id}
                        .{+}
                            _
                        .{+}
                            {Reocrd/insert}
                                [Record/models]
                                    Moment
                            .{Moment/format}
                                YYYY-MM-DD_HH-mm
                        .{+}
                            .json
            {UI/click}
                @a
            {URL/revokeObjectURL}
                [0]
                    .{web.Browser/URL}
                [1]
                    @url
            {Component/trigger}
                [0]
                    @record
                    .{RtcOptionList/component}
                [1]
                    o-popover-close
`;
