/** @odoo-module **/

import { Define } from '@mail/define';

export default Define`
    {Record/insert}
        [Record/models]
            Action
        [Action/name]
            RtcSession/setAudio
        [Action/params]
            audioStream
                [type]
                    MediaStream
            isSelfMuted
                [type]
                    Boolean
            isTalking
                [type]
                    Boolean
            record
                [type]
                    RtcSession
        [Action/behavior]
            :audioElement
                @record
                .{RtcSession/audioElement}
                .{|}
                    {Record/insert}
                        [Record/models]
                            Audio
            {try}
                {Record/update}
                    [0]
                        @audioElement
                    [1]
                        [Audio/srcObject]
                            @audioStream
            .{catch}
                {Record/insert}
                    [Record/models]
                        Function
                    [Function/in]
                        error
                    [Function/out]
                        {Record/update}
                            [0]
                                @record
                            [1]
                                [RtcSession/isAudioInError]
                                    true
                        {Console/log}
                            @error
            {Audio/load}
                @audioElement
            {if}
                @record
                .{RtcSession/partner}
                .{&}
                    @record
                    .{RtcSession/partner}
                    .{Partner/volumeSetting}
            .{then}
                {Record/update}
                    [0]
                        @audioElement
                    [1]
                        [Audio/volume]
                            @record
                            .{RtcSession/partner}
                            .{Partner/volumeSetting}
                            .{VolumeSetting/volume}
            .{elif}
                @record
                .{RtcSession/guest}
                .{&}
                    @record
                    .{RtcSession/guest}
                    .{Guest/volumeSetting}
            .{then}
                {Record/update}
                    [0]
                        @audioElement
                    [1]
                        [Audio/volume]
                            @record
                            .{RtcSession/guest}
                            .{Guest/volumeSetting}
                            .{VolumeSetting/volume}
            .{else}
                {Record/update}
                    [0]
                        @audioElement
                    [1]
                        [Audio/volume]
                            @record
                            .{RtcSession/volume}
            {Record/update}
                [0]
                    @audioElement
                [1]
                    [Audio/muted]
                        {Rtc/currentRtcSession}
                        .{RtcSession/isDeaf}
            {Dev/comment}
                Using both autoplay and play() as safari may prevent play()
                outside of user interactions while some browsers may not support
                or block autoplay.
            {Record/update}
                [0]
                    @audioElement
                [1]
                    [Audio/autoplay]
                        true
            {Record/update}
                [0]
                    @record
                [1]
                    [RtcSession/audioElement]
                        @audioElement
                    [RtcSession/audioStream]
                        @audioStream
                    [RtcSession/isSelfMuted]
                        @isSelfMuted
                    [RtcSession/isTalking]
                        @isTalking
            {try}
                {Audio/play}
                    @audioElement
                {if}
                    {Record/exists}
                        @record
                    .{isFalsy}
                .{then}
                    {break}
                {Record/update}
                    [0]
                        @record
                    [1]
                        [RtcSession/isAudioInError]
                            false
            .{catch}
                {Record/insert}
                    [Record/models]
                        Function
                    [Function/in]
                        error
                    [Function/out]
                        {if}
                            @error
                            .{typeof}
                            .{=}
                                object
                            .{&}
                                @error
                                .{Error/name}
                                .{=}
                                    NotAllowedError
                        .{then}
                            {Dev/comment}
                                Ignored as some browsers may reject play() calls
                                that do not originate from a user input.
                            {break}
                        {if}
                            {Record/exists}
                                @record
                        .{then}
                            {Record/update}
                                [0]
                                    @record
                                [1]
                                    [RtcSession/isAudioInError]
                                        true
                        {Console/error}
                            @error
`;
