/** @odoo-module **/

import { Define } from '@mail/define';

export default Define`

    :tmpId1
        0
    {Record/insert}
        [Record/models]
            Action
        [Action/name]
            _getThreadNextTemporaryId
        [Action/behavior]
            :tmpId1
                @tmpId1
                .{-}
                    1
            @tmpId1

    tmpId2
        0
    {Record/insert}
        [Record/models]
            Action
        [Action/name]
            _getMessageNextTemporaryId
        [Action/behavior]
            :tmpId2
                @tmpId2
                .{-}
                    1
            @tmpId2

    {onChange}
        [onChange/name]
            onThreadIdOrThreadModelChanged
        [onChange/model]
            Chatter
        [onChange/dependencies]
            Chatter/threadId
            Chatter/threadModel
        [onChange/behavior]
            {if}
                @record
                .{Chatter/threadId}
            .{then}
                {if}
                    @record
                    .{Chatter/thread}
                    .{&}
                        @record
                        .{Chatter/thread}
                        .{Thread/isTemporary}
                .{then}
                    {Record/delete}
                        @record
                        .{Chatter/thread}
                {Record/update}
                    [0]
                        @record
                    [1]
                        [Chatter/attachmentBoxView]
                            {if}
                                @record
                                .{Chatter/isAttachmentBoxVisibleInitially}
                            .{then}
                                {Record/insert}
                                    [Record/models]
                                        AttachmentBoxView
                            .{else}
                                {Record/empty}
                        [Chatter/thread]
                            {Record/insert}
                                {Dev/comment}
                                    If the thread was considered to have the activity
                                    mixin once, it will have it forever.
                                [Record/models]
                                    Thread
                                [Thread/hasActivities]
                                    {if}
                                        @record
                                        .{Chatter/hasActivities}
                                    .{then}
                                        true
                                [Thread/id]
                                    @record
                                    .{Chatter/threadId}
                                [Thread/model]
                                    @record
                                    .{Chatter/threadModel}
            .{elif}
                @record
                .{Chatter/thread}
                .{isFalsy}
                .{|}
                    @record
                    .{Chatter/thread}
                    .{Thread/isTemporary}
                    .{isFalsy}
            .{then}
                :message
                    {Record/insert}
                        [Record/models]
                            Message
                        [Message/author]
                            {Env/currentPartner}
                        [Message/body]
                            {Locale/text}
                                Creating a new record...
                        [Message/id]
                            {_getMessageNextTemporaryId}
                        [Message/isTemporary]
                            true
                {Record/update}
                    [0]
                        @record
                    [1]
                        [Chatter/attachmentBoxView]
                            {Record/empty}
                        [Chatter/thread]
                            {Record/insert}
                                [Record/models]
                                    Thread
                                [Thread/areAttachmentsLoaded]
                                    true
                                [Thread/id]
                                    {_getThreadNextTemporaryId}
                                [Thread/isTemporary]
                                    true
                                [Thread/model]
                                    @record
                                    .{Chatter/threadModel}
                {Record/update}
                    [0]
                        @record
                        .{Chatter/thread}
                        .{Thread/cache}
                    [1]
                        [ThreadCache/messages]
                            {Field/add}
                                @message
`;
