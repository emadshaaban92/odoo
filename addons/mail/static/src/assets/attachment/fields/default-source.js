/** @odoo-module **/

import { Define } from '@mail/define';

export default Define`
    {Record/insert}
        [Record/models]
            Field
        [Field/name]
            defaultSource
        [Field/model]
            Attachment
        [Field/type]
            attr
        [Field/target]
            String
        [Field/compute]
            {if}
                @record
                .{Attachment/isImage}
            .{then}
                /web/image/
            .{+}
                @record
                .{Attachment/id}
            .{+}
                ?signature=
            .{+}
                @record
                .{Attachment/checksum}
            .{elif}
                @record
                .{Attachment/isPdf}
            .{then}
                :pdf_lib
                    /web/static/lib/pdfjs/web/viewer.html?file=
                {if}
                    @record
                    .{Attachment/accessToken}
                    .{isFalsy}
                    .{&}
                        @record
                        .{Attachment/originThread}
                    .{&}
                        @record
                        .{Attachment/originThread}
                        .{Thread/model}
                        .{=}
                            mail.channel
                .{then}
                    @pdf_lib
                    .{+}
                        /mail/channel/
                    .{+}
                        @record
                        .{Attachment/originThread}
                        .{Thread/id}
                    .{+}
                        /attachment/
                    .{+}
                        @record
                        .{Attachment/id}
                .{else}
                    :accessToken
                        {if}
                            @record
                            .{Attachment/accessToken}
                        .{then}
                            ?access_token%3D
                            .{+}
                                @record
                                .{Attachment/accessToken}
                @pdf_lib
                .{+}
                    /web/content/
                .{+}
                    @record
                    .{Attachment/id}
                .{+}
                    @accessToken
            .{elif}
                @record
                .{Attachment/isUrlYoutube}
            .{then}
                :urlArr
                    @record
                    .{Attachment/url}
                    .{String/split}
                        /
                :token
                    @urlArr
                    .{Collection/last}
                {if}
                    @token
                    .{String/includes}
                        watch
                .{then}
                    :token
                        @token
                        .{String/split}
                            v=
                        .{Collection/second}
                    :amp
                        @token
                        .{String/indexOf}
                            &
                    {if}
                        @amp
                        .{!=}
                            -1
                    .{then}
                        :token
                            @token
                            .{String/substring}
                                0
                                @amp
                https://www.youtube.com/embed/
                .{+}
                    @token
            .{elif}
                @record
                .{Attachment/accessToken}
                .{isFalsy}
                .{&}
                    @record
                    .{Attachment/originThread}
                .{&}
                    @record
                    .{Attachment/originThread}
                    .{Thread/model}
                    .{=}
                        mail.channel
            .{then}
                /mail/channel/
                .{+}
                    @record
                    .{Attachment/originThread}
                    .{Thread/id}
                .{+}
                    /attachment/
                .{+}
                    @record
                    .{Attachment/id}
            .{else}
                :accessToken
                    {if}
                        @record
                        .{Attachment/accessToken}
                    .{then}
                        ?access_token=
                        .{+}
                            @record
                            .{Attachment/accessToken}
                /web/content/
                .{+}
                    @record
                    .{Attachment/id}
                .{+}
                    @accessToken
`;
