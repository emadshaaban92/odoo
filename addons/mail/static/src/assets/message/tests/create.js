/** @odoo-module **/

import { Define } from '@mail/define';

export default Define`
    {Record/insert}
        [Record/models]
            Test
        [Test/name]
            create
        [Test/model]
            Message
        [Test/assertions]
            30
        [Test/scenario]
            :testEnv
                {Record/insert}
                    [Record/models]
                        Env
            @testEnv
            .{Record/insert}
                [Record/models]
                    Server
                [Server/data]
                    @record
                    .{Test/data}
            {Test/assert}
                @testEnv
                .{Record/findById}
                    [Partner/id]
                        5
                .{isFalsy}
            {Test/assert}
                @testEnv
                .{Record/findById}
                    [Thread/id]
                        100
                    [Thread/model]
                        mail.channel
                .{isFalsy}
            {Test/assert}
                @testEnv
                .{Record/findById}
                    [Attachment/id]
                        750
                .{isFalsy}
            {Test/assert}
                @testEnv
                .{Record/findById}
                    [Message/id]
                        4000
                .{isFalsy}

            :thread
                @testEnv
                .{Record/insert}
                    [Record/models]
                        Thread
                    [Thread/id]
                        100
                    [Thread/model]
                        mail.channel
                    [Thread/name]
                        General
            :message
                @testEnv
                .{Record/insert}
                    [Record/models]
                        Message
                    [Message/attachments]
                        @testEnv
                        .{Record/insert}
                            [Record/models]
                                Attachment
                            [Attachment/filename]
                                test.txt
                            [Attachment/id]
                                750
                            [Attachment/mimetype]
                                text/plain
                            [Attachment/name]
                                test.txt
                    [Message/author]
                        @testEnv
                        .{Record/insert}
                            [Record/models]
                                Partner
                            [Partner/displayName]
                                Demo
                            [Partner/id]
                                5
                    [Message/body]
                        <p>Test</p>
                    [Message/date]
                        {Record/insert}
                            [Record/models]
                                Moment
                            {String/toDatetime}
                                2019-05-05 10:00:00
                    [Message/id]
                        4000
                    [Message/isNeedaction]
                        true
                    [Message/isStarred]
                        true
                    [Message/originThread]
                        @thread
            {Test/assert}
                @testEnv
                .{Record/findById}
                    [Partner/id]
                        5
            {Test/assert}
                @testEnv
                .{Record/findById}
                    [Thread/id]
                        100
                    [Thread/model]
                        mail.channel
            {Test/assert}
                @testEnv
                .{Record/findById}
                    [Attachment/id]
                        750
            {Test/assert}
                @testEnv
                .{Record/findById}
                    [Message/id]
                        4000
            {Test/assert}
                @message
            {Test/assert}
                @testEnv
                .{Record/findById}
                    [Message/id]
                        4000
                .{=}
                    @message
            {Test/assert}
                @message
                .{Message/body}
                .{=}
                    <p>Test</p>
            {Test/assert}
                {Record/insert}
                    [Record/models]
                        Moment
                    @message
                    .{Message/date}
                .{Moment/utc}
                .{Moment/format}
                    YYYY-MM-DD hh:mm:ss
                .{=}
                    2019-05-05 10:00:00
            {Test/assert}
                @message
                .{Message/id}
                .{=}
                    4000
            {Test/assert}
                @message
                .{Message/originThread}
                .{=}
                    @testEnv
                    .{Record/findById}
                        [Thread/id]
                            100
                        [Thread/model]
                            mail.channel
            {Test/assert}
                @message
                .{Message/threads}
                .{Collection/includes}
                    @testEnv
                    .{Record/findById}
                        [Thread/id]
                            100
                        [Thread/model]
                            mail.channel
            {Dev/comment}
                from partnerId being in needaction_partner_ids
            {Test/assert}
                @message
                .{Message/threads}
                .{Collection/includes}
                    @testEnv
                    .{Env/inbox}
            {Dev/comment}
                from partnerId being in starred_partner_ids
            {Test/assert}
                @message
                .{Message/threads}
                .{Collection/includes}
                    @testEnv
                    .{Env/starred}
            :attachment
                @testEnv
                .{Record/findById}
                    [Attachment/id]
                        750
            {Test/assert}
                @attachment
            {Test/assert}
                @attachment
                .{Attachment/filename}
                .{=}
                    test.txt
            {Test/assert}
                @attachment
                .{Attachment/id}
                .{=}
                    750
            {Test/assert}
                @attachment
                .{Attachment/isUploading}
                .{isFalsy}
            {Test/assert}
                @attachment
                .{Attachment/mimetype}
                .{=}
                    text/plain
            {Test/assert}
                @attachment
                .{Attachment/name}
                .{=}
                    test.txt
            :channel
                @testEnv
                .{Record/findById}
                    [Thread/id]
                        100
                    [Thread/model]
                        mail.channel
            {Test/assert}
                @channel
            {Test/assert}
                @channel
                .{Thread/model}
                .{=}
                    mail.channel
            {Test/assert}
                @channel
                .{Thread/id}
                .{=}
                    100
            {Test/assert}
                @channel
                .{Thread/name}
                .{=}
                    General
            :partner
                @testEnv
                .{Record/findById}
                    [Partner/id]
                        5
            {Test/assert}
                @partner
            {Test/assert}
                @partner
                .{Partner/displayName}
                .{=}
                    Demo
            {Test/assert}
                @partner
                .{Partner/id}
                .{=}
                    5
`;
