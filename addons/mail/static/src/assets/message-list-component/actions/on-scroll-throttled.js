/** @odoo-module **/

import { Define } from '@mail/define';

export default Define`
    {Record/insert}
        [Record/models]
            Action
        [Action/name]
            MessageListComponent/_onScrollThrottled
        [Action/params]
            record
                [type]
                    MessageListComponent
        [Action/behavior]
            {if}
                @record
                .{MessageListComponent/messageListView}
                .{isFalsy}
            .{then}
                {break}
            {if}
                {MessageListComponent/_getScrollableElement}
                    @record
                .{isFalsy}
            .{then}
                {Dev/comment}
                    could be unmounted in the meantime
                    (due to throttled behavior)
                {break}
            :scrollTop
                {MessageListComponent/_getScrollableElement}
                    @record
                .{web.Element/scrollTop}
            {Env/messagingBus}
            .{Bus/trigger}
                [0]
                    o-component-message-list-scrolled
                [1]
                    [orderedMessages]
                        @record
                        .{MessageListComponent/messageListView}
                        .{MessageListView/threadViewOwner}
                        .{ThreadView/threadCache}
                        .{ThreadCache/orderedMessages}
                    [scrollTop]
                        @scrollTop
                    [thread]
                        @record
                        .{MessageListComponent/messageListView}
                        .{MessageListView/threadViewOwner}
                        .{ThreadView/thread}
                    [threadViewer]
                        @record
                        .{MessageListComponent/messageListView}
                        .{MessageListView/threadViewOwner}
                        .{ThreadView/threadViewer}
            {if}
                @record
                .{MessageListComponent/messageListView}
            .{then}
                {Record/update}
                    [0]
                        @record
                        .{MessageListComponent/messageListView}
                    [1]
                        [MessageListView/clientHeight]
                            {MessageListComponent/_getScrollableElement}
                                @record
                            .{web.Element/clientHeight}
                        [MessageListView/scrollHeight]
                            {MessageListComponent/_getScrollableElement}
                                @record
                            .{web.Element/scrollHeight}
                        [MessageListView/scrollTop]
                            {MessageListComponent/_getScrollableElement}
                                @record
                            .{web.Element/scrollTop}
            {if}
                @record
                .{MessageListComponent/messageListView}
                .{MessageListView/isLastScrollProgrammatic}
                .{&}
                    @record
                    .{MessageListComponent/messageListView}
                    .{MessageListView/threadViewOwner}
            .{then}
                {Dev/comment}
                    Automatically scroll to new received messages only
                    when the list is currently fully scrolled.
                :hasAutoScrollOnMessageReceived
                    @record
                    .{MessageListComponent/messageListView}
                    .{MessageListView/isAtEnd}
                {Record/update}
                    [0]
                        @record
                        .{MessageListComponent/messageListView}
                        .{MessageListView/threadViewOwner}
                    [1]
                        [ThreadView/hasAutoScrollOnMessageReceived]
                            @hasAutoScrollOnMessageReceived
            {if}
                @record
                .{MessageListComponent/messageListView}
                .{MessageListView/threadViewOwner}
            .{then}
                {ThreadViewer/saveThreadCacheScrollHeightAsInitial}
                    [0]
                        @record
                        .{MessageListComponent/messageListView}
                        .{MessageListView/threadViewOwner}
                        .{ThreadView/threadViewer}
                    [1]
                        {MessageListComponent/_getScrollableElement}
                            @record
                        .{web.Element/scrollHeight}
                    [2]
                        @record
                        .{MessageListComponent/messageListView}
                        .{MessageListView/threadViewOwner}
                        .{ThreadView/threadCache}
                {ThreadViewer/saveThreadCacheScrollPositionsAsInitial}
                    [0]
                        @record
                        .{MessageListComponent/messageListView}
                        .{MessageListView/threadViewOwner}
                        .{ThreadView/threadViewer}
                    [1]
                        @scrollTop
                    [2]
                        @record
                        .{MessageListComponent/messageListView}
                        .{MessageListView/threadViewOwner}
                        .{ThreadView/threadCache}
            {if}
                @record
                .{MessageListComponent/messageListView}
                .{MessageListView/isLastScrollProgrammatic}
                .{isFalsy}
                .{&}
                    {MessageListComponent/_isLoadMoreVisible}
                        @record
            .{then}
                {MessageListComponent/_loadMore}
                    @record
            {MessageListComponent/_checkMostRecentMessageIsVisible}
                @record
            {Record/update}
                [0]
                    @record
                    .{MessageListComponent/messageListView}
                [1]
                    [MessageListView/isLastScrollProgrammatic]
                        false
`;
